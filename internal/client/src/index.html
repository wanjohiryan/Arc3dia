<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>TIME WARP</title>
    <link rel="stylesheet" href="player.css" />
  </head>

  <body>
    <div id="player">
      <div id="screen">
        <div id="play">
          <div id="play-btn">
            <img src="./icons/Play.svg" id="play-icon" />
          </div>
        </div>
        <div id="play2">
          <div id="info-container" class="info-container hide-display">
            <div id="close-info-tab">
              <div id="close-btn">
                <img
                  src="./icons/Close.svg"
                  id="info-close-icon"
                  class="close-icon"
                />
              </div>
            </div>

            <div id="name-value-container">
              <div id="duo-containers">Name</div>
              <div id="duo-containers">Value</div>
            </div>

            <div id="name-value-container">
              <div class="text-style">Video Codec</div>
              <div id="video-codec" class="text-style"></div>
            </div>

            <div id="name-value-container">
              <div class="text-style">Audio Codec</div>
              <div id="audio-codec" class="text-style"></div>
            </div>

            <div id="name-value-container">
              <div class="text-style">Video Buffer</div>
              <div id="video-buffer" class="buffer-style"></div>
            </div>

            <div id="name-value-container">
              <div class="text-style">Audio Buffer</div>
              <div id="audio-buffer" class="buffer-style"></div>
            </div>

            <div id="name-value-container">
              <div class="text-style">Latency from source</div>
              <div id="latency-source" class="text-style"></div>
            </div>

            <div id="name-value-container">
              <div class="text-style">Video resolution</div>
              <div id="vid-res" class="text-style"></div>
            </div>

            <div id="name-value-container">
              <div class="text-style">Latency mode</div>
              <div id="latency-mode" class="text-style"></div>
            </div>
          </div>

          <!-- <div id="name-value-container">
            <div class="text-style">Protocol</div>
            <div class="text-style">HLS</div>
          </div> -->

          <div id="settings-container" class="settings-container hide-display">
            <div id="close-settings-tab">
              <div id="close-settings-btn">
                <img
                  src="./icons/Close.svg"
                  id="settings-close-icon"
                  class="close-icon"
                />
              </div>
            </div>

            <div id="latency-setting">
              <div class="settings-text-style">Lowest latency</div>
              <!-- use a ticker -->
              <div class="radio-latency-style">
                <label class="switch">
                  <input id="switch" type="checkbox" />
                  <span class="slider"></span>
                </label>
              </div>
            </div>
          </div>
          <!-- <div id="info-container"></div> -->
          <div id="bottom-container">
            <div id="bottom-controls">
              <div id="bottom-btn">
                <img
                  src="./icons/Info Square.svg"
                  id="info-icon"
                  class="bottom-icon"
                />
              </div>

              <div id="bottom-btn">
                <img
                  src="./icons/Setting.svg"
                  id="settings-icon"
                  class="bottom-icon"
                />
              </div>

              <div id="bottom-btn">
                <img
                  src="./icons/Volume On.svg"
                  id="volume-up-icon"
                  class="bottom-icon hide-display"
                />
                <img
                  src="./icons/Volume Off.svg"
                  id="volume-down-icon"
                  class="bottom-icon"
                />
              </div>

              <div id="bottom-btn">
                <img
                  src="./icons/Fullscreen.svg"
                  id="fullscreen-icon"
                  class="bottom-icon"
                />
              </div>
            </div>
          </div>
        </div>
        <video id="vid"></video>
        <div id="more-info"></div>
      </div>

      <!-- <div id="controls">
			<button type="button" id="throttle">Throttle: None</button>
		</div> -->
    </div>

    <script type="module">
      import { Player } from "./player.ts";

      // This is so ghetto but I'm too lazy to improve it right now
      const vidRef = document.getElementById("vid");
      const vidRes = document.getElementById("vid-res");
      const playerRef = document.getElementById("player");
      const latencySource = document.getElementById("latency-source");
      const infoContainer = document.getElementById("info-container");
      const infoCloseIcon = document.getElementById("info-close-icon");
      const latencyMode = document.getElementById("latency-mode");
      const infoIcon = document.getElementById("info-icon");
      const settingsIcon = document.getElementById("settings-icon");
      const settingsCloseIcon = document.getElementById("settings-close-icon");
      const settingsContainer = document.getElementById("settings-container");
      const fullscreenIcon = document.getElementById("fullscreen-icon");
      const volumeUpIcon = document.getElementById("volume-up-icon");
      const volumeDownIcon = document.getElementById("volume-down-icon");
      const bottomBtn = document.getElementById("bottom-btn");
      const switchRef = document.getElementById("switch");
      const audioBufferRef = document.getElementById("audio-buffer");
      const videoBufferRef = document.getElementById("video-buffer");
      // const throttleRef = document.getElementById("throttle");
      const playRef = document.getElementById("play-btn");
      const playBackRef = document.getElementById("play");

      const audioCodec = document.getElementById("audio-codec");
      const videoCodec = document.getElementById("video-codec");

      const params = new URLSearchParams(window.location.search);

      const player = new Player({
        url: params.get("url") || "https://localhost:4443",

        vid: vidRef,
        audioBuffer: audioBufferRef,
        videoBuffer: videoBufferRef,
        audioCodec,
        videoCodec,
        vidRes,
        latencySource
      });

      // throttleRef.addEventListener("click", (e) => {
      //   e.preventDefault();
      //   player.throttle();
      // });

      switchRef.addEventListener("change", function (event) {
        let runForever;

        //TODO: tighten this check? Too loose
        if (event.target.checked) {
          localStorage.setItem("live", true);
          latencyMode.innerHTML = "Low";
          //TODO: call go live if buffer goes beyond a certain threshold
          player.goLive();
        } else {
          localStorage.setItem("live", false);
          latencyMode.innerHTML = "Normal";
        }
      });

      // on startup, check whether user prefers live or normal latency mode
      if (localStorage.getItem("live")) {
        switchRef.checked = true;
        latencyMode.innerHTML = "Low";
      }

      // close info card
      infoCloseIcon.addEventListener("click", (e) => {
        infoContainer.classList.add("hide-display");

        e.preventDefault();
      });

      // close settings card
      settingsCloseIcon.addEventListener("click", (e) => {
        settingsContainer.classList.add("hide-display");

        e.preventDefault();
      });

      // show settings card, close info card if open
      settingsIcon.addEventListener("click", (e) => {
        settingsContainer.classList.remove("hide-display");
        infoContainer.classList.add("hide-display");

        e.preventDefault();
      });

      // set timewarp to fullscreen mode
      fullscreenIcon.addEventListener("click", (e) => {
        settingsContainer.classList.add("hide-display");
        infoContainer.classList.add("hide-display");
        playerRef.requestFullscreen();

        e.preventDefault();
      });

      // display infocard and close settings card if open
      infoIcon.addEventListener("click", (e) => {
        settingsContainer.classList.add("hide-display");
        infoContainer.classList.remove("hide-display");

        e.preventDefault();
      });

      vidRef.addEventListener("volumechange", () => {
          console.log("muted", vidRef.muted);

          if(vidRef.muted){
            volumeUpIcon.classList.remove("hide-display");
            volumeDownIcon.classList.add("hide-display");
          }

        });

      //This is a fix to parcel. Does not bundle volume off icon on 'serve'
      // increase volume
      volumeUpIcon.addEventListener("click", (e) => {
        vidRef.muted = false;
        volumeUpIcon.classList.add("hide-display");

        volumeDownIcon.classList.remove("hide-display");

        e.preventDefault();
      });

      // reduce volume
      volumeDownIcon.addEventListener("click", (e) => {
        vidRef.muted = true;
        volumeDownIcon.classList.add("hide-display");

        volumeUpIcon.classList.remove("hide-display");

        e.preventDefault();
      });

      playRef.addEventListener("click", (e) => {
        vidRef.play();
        e.preventDefault();
      });

      function playFunc(e) {
        playBackRef.style.display = "none";

        // Only fire once to restore pause/play functionality
        vidRef.removeEventListener("play", playFunc);
      }

      vidRef.addEventListener("play", playFunc);
      // vidRef.volume = 0.5;

      // Try to autoplay but ignore errors on mobile; they need to click
      //vidRef.play().catch((e) => console.warn(e))
    </script>
  </body>
</html>
